<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Water Dashboard</title>
  
  <!-- Chart.js (for Raw, Percentage, Trend tabs) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  
  <!-- React, ReactDOM, Babel (for Distribution tab) -->
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  
  <!-- Add prop-types dependency for Recharts -->
  <script src="https://unpkg.com/prop-types@15.6/prop-types.min.js"></script> 
  
  <!-- Recharts (for Distribution tab) - Switched to jsDelivr CDN -->
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.7/umd/Recharts.min.js"></script>
  
  <!-- Babel (must be after React/Recharts) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind CSS (via CDN for styling consistency with React component) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  
  <style>
    /* Keep existing styles for overall layout and non-React tabs */
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f8f9fa;
      color: #333;
    }
    
    .header {
      background: linear-gradient(to right, #0d47a1, #1976d2);
      color: white;
      padding: 2rem 1rem;
      text-align: center;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    
    .tab-links {
      display: flex;
      flex-wrap: wrap;
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 2rem;
    }
    
    .tab-link {
      padding: 0.75rem 1rem;
      cursor: pointer;
      background-color: #f1f1f1;
      border: none;
      border-radius: 5px 5px 0 0;
      margin-right: 0.5rem;
      margin-bottom: -1px; /* Overlap border */
      transition: all 0.3s;
      border: 1px solid transparent;
      border-bottom: none;
    }
    
    .tab-link.active {
      background-color: white;
      border-color: #dee2e6 #dee2e6 white;
      border-bottom: 3px solid #1976d2;
      color: #1976d2;
      font-weight: bold;
    }
    
    .tab-link:hover:not(.active) {
      background-color: #e9ecef;
    }
    
    .tab-content {
      display: none;
      background-color: white;
      padding: 2rem;
      border: 1px solid #dee2e6;
      border-top: none;
      border-radius: 0 5px 5px 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .chart-container {
      position: relative; /* Needed for Chart.js responsiveness */
      height: 400px;
      width: 100%;
      margin-bottom: 2rem;
    }
    
    .info-box {
      background-color: #e6f3ff;
      padding: 1rem;
      border-left: 4px solid #1976d2;
      border-radius: 4px;
      margin-bottom: 1.5rem;
    }
    
    .footer {
      background-color: #343a40;
      color: #adb5bd;
      padding: 1.5rem 1rem;
      text-align: center;
      margin-top: 2rem;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
    
    @media (min-width: 768px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .card {
      background-color: #f1f1f1;
      padding: 1.5rem;
      border-radius: 4px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    table th, table td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    
    table th {
      background-color: #f1f1f1;
    }
    
    h1, h2, h3 {
      margin-top: 0;
    }
        
    .subtitle {
      font-style: italic;
      color: #6c757d;
      margin-bottom: 1.5rem;
    }
        
    /* Styles needed by React component if not covered by Tailwind */
    .recharts-tooltip-wrapper {
      z-index: 1000 !important; /* Ensure tooltip is on top */
    }
    
  </style>
</head>
<body>
  <header class="header">
    <div class="container">
      <h1>Max Outflow Uncertainty Dashboard</h1>
      <p>
        Interactive analysis of climate scenarios (2050 baseline, Urban development, Replanting efforts)
        and their impact on maximum water outflow across different rainfall event severities.
      </p>
    </div>
  </header>
  
  <main class="container">
    <div class="tab-links">
      <button class="tab-link active" id="tab-raw">Raw Outflow</button>
      <button class="tab-link" id="tab-distribution">Distribution Analysis</button>
      <button class="tab-link" id="tab-percentage">Percentage Change</button>
      <button class="tab-link" id="tab-trends">Trend Analysis</button>
    </div>
    
    <!-- Raw Outflow Tab (Chart.js) -->
    <div id="raw" class="tab-content active">
      <h2>Raw Max Outflow Comparison</h2>
      <p class="subtitle">Summary values representing multiple return periods</p>
      
      <div class="info-box">
        <p>
          This chart compares the absolute maximum outflow values (in cms) across all scenarios and return periods. 
          Higher values indicate increased water flow volume during rainfall events.
        </p>
      </div>
      
      <div class="chart-container">
        <canvas id="rawChart"></canvas>
      </div>
    </div>
    
    <!-- Distribution Analysis Tab (React/Recharts) -->
    <div id="distribution" class="tab-content">
      <!-- React component will render here -->
      <div id="distributionReactRoot"></div> 
    </div>
    
    <!-- Percentage Change Tab (Chart.js) -->
    <div id="percentage" class="tab-content">
      <h2>Percentage Change from 2050 Baseline</h2>
      <p class="subtitle">Calculated from summary values representing multiple return periods</p>
      
      <div class="info-box">
        <p>
          This chart shows how the Urban and Replant scenarios compare to the 2050 Baseline in percentage terms.
          Negative values indicate reduced outflow compared to the baseline scenario.
        </p>
      </div>
      
      <div class="chart-container">
        <canvas id="percentageChart"></canvas>
      </div>
    </div>
    
    <!-- Trend Analysis Tab (Chart.js) -->
    <div id="trends" class="tab-content">
      <h2>Trend Analysis: Scenario Changes Across Events</h2>
      <p class="subtitle">Showing percentage change from current conditions</p>
      
      <div class="info-box">
        <p>
          This visualization shows how the impact of different scenarios changes across rainfall event severities.
          The chart displays percentage changes relative to current conditions, highlighting how climate change and land use 
          strategies affect water outflows differently across event scales.
        </p>
      </div>
      
      <div class="chart-container">
        <canvas id="trendChart"></canvas>
      </div>
      
      <div class="grid" style="margin-top: 2rem;">
        <div class="card">
          <h3>Key Observations</h3>
          <ul>
            <li>The impact of <span class="font-semibold" style="color: #fd7e14;">climate change (2050 baseline)</span> increases with rainfall severity - up to <span class="font-semibold">45%</span> higher outflow for 200-year events.</li>
            <li><span class="font-semibold" style="color: #17a2b8;">Replanting efforts</span> are most effective at reducing outflow during smaller events (2-year return periods).</li>
            <li><span class="font-semibold" style="color: #dc3545;">Urban development</span> shows minimal additional impact at extreme events (200-year peak).</li>
            <li>All future scenarios converge at extreme events, suggesting limited mitigation options for the most severe rainfall scenarios.</li>
          </ul>
        </div>
        
        <div class="card">
          <h3>Implications</h3>
          <ul>
            <li>Planning for <span class="font-semibold">greater outflow capacity</span> is critical across all future scenarios.</li>
            <li>The most dramatic increases in outflow occur between current conditions and the 2050 baseline.</li>
            <li>Mitigation strategies have diminishing returns as rainfall severity increases.</li>
            <li>Under 200-year peak events, all climate scenarios produce over <span class="font-semibold">45% more outflow</span> compared to current conditions.</li>
          </ul>
        </div>
      </div>
    </div>
  </main>
  
  <footer class="footer">
    <div class="container">
      <p>Max Outflow Uncertainty Dashboard | Data from uncertainty.csv</p>
    </div>
  </footer>

  <script>
    // Static data for backup (will be replaced by Excel data if available)
    window.rawOutflowData = [
      { category: '2yr - Low', Current: 1.216666, Baseline: 1.326637, Replant: 1.261602, Urban: 1.332193 },
      { category: '2yr - Peak', Current: 2.198027, Baseline: 2.427346, Replant: 2.323949, Urban: 2.43629 },
      { category: '200yr - Low', Current: 7.177433, Baseline: 11.651535, Replant: 11.504162, Urban: 11.678737 },
      { category: '200yr - Peak', Current: 15.84633, Baseline: 23.097431, Replant: 22.843051, Urban: 23.118788 }
    ];
    
    window.percentageChangeData = [
      { category: '2yr - Low', Urban: 0.4188, Replant: -4.9022 },
      { category: '2yr - Peak', Urban: 0.3685, Replant: -4.2597 },
      { category: '200yr - Low', Urban: 0.2335, Replant: -1.2648 },
      { category: '200yr - Peak', Urban: 0.0925, Replant: -1.1013 }
    ];
    
    window.trendData = window.rawOutflowData.map(item => ({
      name: item.category,
      Current: 0, // Current is always 0% (reference point)
      Baseline: ((item.Baseline - item.Current) / item.Current) * 100,
      Replant: ((item.Replant - item.Current) / item.Current) * 100,
      Urban: ((item.Urban - item.Current) / item.Current) * 100,
      rawCurrent: item.Current,
      rawBaseline: item.Baseline,
      rawReplant: item.Replant,
      rawUrban: item.Urban,
    }));
    
    window.boxPlotData = {
      '2yr-low': { current: [1.20, 1.21, 1.22, 1.23, 1.22, 1.21, 1.22, 1.21, 1.22, 1.20], baseline: [1.32, 1.33, 1.32, 1.33, 1.32, 1.33, 1.32, 1.33, 1.33, 1.32], replant: [1.25, 1.26, 1.26, 1.27, 1.26, 1.25, 1.26, 1.27, 1.25, 1.26], urban: [1.33, 1.34, 1.33, 1.33, 1.32, 1.33, 1.34, 1.33, 1.33, 1.32] },
      '2yr-peak': { current: [2.1956, 2.2103, 2.209, 2.2096, 2.2119, 2.2083, 2.2094, 2.2116, 2.1943, 2.185], baseline: [2.4027, 2.4481, 2.4328, 2.4313, 2.4261, 2.4392, 2.4263, 2.357, 2.4254, 2.4365], replant: [2.3327, 2.3218, 2.3366, 2.339, 2.3296, 2.327, 2.3238, 2.3082, 2.3203, 2.3035], urban: [2.4239, 2.4264, 2.4532, 2.4207, 2.4541, 2.4471, 2.4446, 2.4456, 2.4229, 2.4531] },
      '200yr-low': { current: [7.10, 7.21, 7.17, 7.19, 7.15, 7.22, 7.14, 7.18, 7.16, 7.20], baseline: [11.58, 11.66, 11.63, 11.69, 11.61, 11.67, 11.60, 11.70, 11.62, 11.64], replant: [11.44, 11.52, 11.48, 11.53, 11.47, 11.51, 11.45, 11.54, 11.46, 11.50], urban: [11.61, 11.70, 11.65, 11.72, 11.64, 11.69, 11.63, 11.73, 11.66, 11.68] },
      '200yr-peak': { current: [15.71, 15.82, 15.90, 15.85, 15.78, 15.93, 15.88, 15.77, 15.80, 15.95], baseline: [22.95, 23.12, 23.21, 23.05, 23.14, 23.07, 23.18, 22.97, 23.16, 23.09], replant: [22.71, 22.85, 22.81, 22.92, 22.77, 22.88, 22.80, 22.93, 22.82, 22.75], urban: [23.01, 23.15, 23.08, 23.19, 23.06, 23.17, 23.09, 23.21, 23.11, 23.05] }
    };
    
    // Chart.js Instances (for non-React tabs)
    let rawChartInstance, percentageChartInstance, trendChartInstance;

    // Load data from uncertainty.xlsx using XLSX library
    // Try to load Excel data, but keep existing data if loading fails
    async function tryLoadExcelData() {
      try {
        console.log("Attempting to load Excel data...");
        const response = await fetch('uncertainty.xlsx');
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        
        console.log("Excel file loaded, sheet names:", workbook.SheetNames);
        
        // Only replace existing data if we successfully parse something
        if (workbook.SheetNames.length > 0) {
          // Try to load data from specific sheets or use first available
          try {
            // For raw data - check first sheet
            if (workbook.SheetNames[0]) {
              const rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
              if (rawData && rawData.length > 0 && 
                  rawData[0].category && rawData[0].Current && 
                  rawData[0].Baseline && rawData[0].Replant) {
                window.rawOutflowData = rawData;
                console.log("Loaded raw data from Excel");
              }
            }
            
            // For percentage data - check second sheet
            if (workbook.SheetNames[1]) {
              const pctData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[1]]);
              if (pctData && pctData.length > 0 && 
                  pctData[0].category && 
                  (pctData[0].Urban !== undefined) && 
                  (pctData[0].Replant !== undefined)) {
                window.percentageChangeData = pctData;
                console.log("Loaded percentage data from Excel");
              }
            }
            
            // Regenerate trend data
            console.log("Regenerating trend data");
            window.trendData = window.rawOutflowData.map(item => ({
              name: item.category,
              Current: 0,
              Baseline: ((item.Baseline - item.Current) / item.Current) * 100,
              Replant: ((item.Replant - item.Current) / item.Current) * 100,
              Urban: ((item.Urban - item.Current) / item.Current) * 100,
              rawCurrent: item.Current,
              rawBaseline: item.Baseline,
              rawReplant: item.Replant,
              rawUrban: item.Urban,
            }));
          } catch (err) {
            console.error("Error processing Excel data:", err);
          }
        }
        
      } catch (error) {
        console.error("Could not load Excel file:", error);
      }
      
      // Initialize charts with whatever data we have
      console.log("Initializing charts with available data");
      window.initializeRawChart = initializeRawChart;
      window.initializePercentageChart = initializePercentageChart;
      window.initializeTrendChart = initializeTrendChart;
      
      initializeRawChart();
      initializePercentageChart();
      initializeTrendChart();
    }
    
    // Start by trying to load Excel data, but we already have static data as backup
    tryLoadExcelData();

    // Initialize charts and tabs
    document.addEventListener('DOMContentLoaded', function() {
      const distributionTabContent = document.getElementById('distribution');
      const distributionReactRoot = document.getElementById('distributionReactRoot');
      
      // Initialize tabs
      const tabLinks = document.querySelectorAll('.tab-link');
      tabLinks.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.id.replace('tab-', '');
          
          // Hide all tabs and remove active class from links
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
          
          // Show the selected tab and mark link as active
          const activeContent = document.getElementById(tabId);
          if (activeContent) activeContent.classList.add('active');
          this.classList.add('active');
          
          // Mount/Unmount React component for Distribution tab
          if (tabId === 'distribution') {
            // Ensure Babel has processed the script before rendering
             setTimeout(() => {
                if (typeof DistributionAnalysisComponent !== 'undefined') {
                    ReactDOM.render(React.createElement(DistributionAnalysisComponent), distributionReactRoot);
                } else {
                    console.error('DistributionAnalysisComponent not found. Babel might not have finished.');
                }
            }, 0);
          } else {
            // Unmount React component if it exists and we are switching away
            if (distributionReactRoot.hasChildNodes()) {
              ReactDOM.unmountComponentAtNode(distributionReactRoot);
            }
          }
          
          // Initialize Chart.js charts if they haven't been already and the tab is active
          if (tabId === 'raw' && !rawChartInstance) {
            initializeRawChart();
          } else if (tabId === 'percentage' && !percentageChartInstance) {
            initializePercentageChart();
          } else if (tabId === 'trends' && !trendChartInstance) {
            initializeTrendChart();
          }
        });
      });
      
      // Initialize the default active tab's chart (Raw Outflow)
      initializeRawChart();

    }); // End DOMContentLoaded

    // --- Chart.js Initialization Functions ---
    
    function initializeRawChart() {
        const rawCtx = document.getElementById('rawChart')?.getContext('2d');
        if (!rawCtx) return; // Don't initialize if canvas not visible/found
        if (rawChartInstance) rawChartInstance.destroy(); // Destroy previous instance if exists
        rawChartInstance = new Chart(rawCtx, {
            type: 'bar',
            data: {
            labels: rawOutflowData.map(d => d.category),
            datasets: [
                { label: 'Current Conditions', data: rawOutflowData.map(d => d.Current), backgroundColor: '#0056b3', borderRadius: 4 },
                { label: '2050 Baseline (ViT)', data: rawOutflowData.map(d => d.Baseline), backgroundColor: '#fd7e14', borderRadius: 4 },
                { label: 'Replanting Efforts', data: rawOutflowData.map(d => d.Replant), backgroundColor: '#17a2b8', borderRadius: 4 },
                { label: 'Urban Development', data: rawOutflowData.map(d => d.Urban), backgroundColor: '#dc3545', borderRadius: 4 }
            ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Max Outflow (cms)' } } }, plugins: { tooltip: { callbacks: { label: function(context) { return `${context.dataset.label}: ${context.raw.toFixed(2)} cms`; } } } } }
        });
    }

    function initializePercentageChart() {
        const percentageCtx = document.getElementById('percentageChart')?.getContext('2d');
        if (!percentageCtx) return;
        if (percentageChartInstance) percentageChartInstance.destroy();
        percentageChartInstance = new Chart(percentageCtx, {
            type: 'bar',
            data: {
            labels: percentageChangeData.map(d => d.category),
            datasets: [
                { label: 'Urban vs 2050', data: percentageChangeData.map(d => d.Urban), backgroundColor: '#dc3545', borderRadius: 4 },
                { label: 'Replant vs 2050', data: percentageChangeData.map(d => d.Replant), backgroundColor: '#17a2b8', borderRadius: 4 }
            ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { title: { display: true, text: 'Change from Baseline (%)' }, ticks: { callback: function(value) { return value.toFixed(1) + '%'; } }, min: -6, max: 2 } }, plugins: { tooltip: { callbacks: { label: function(context) { return `${context.dataset.label}: ${context.raw.toFixed(2)}%`; } } } } }
        });
    }

    function initializeTrendChart() {
        const trendCtx = document.getElementById('trendChart')?.getContext('2d');
        if (!trendCtx) return;
        if (trendChartInstance) trendChartInstance.destroy();
        trendChartInstance = new Chart(trendCtx, {
            type: 'line',
            data: {
            labels: trendData.map(d => d.name),
            datasets: [
                { label: 'Current Conditions', data: trendData.map(d => d.Current), borderColor: '#0056b3', backgroundColor: '#0056b3', tension: 0.1, borderWidth: 3, pointRadius: 6, pointHoverRadius: 8 },
                { label: '2050 Baseline (ViT)', data: trendData.map(d => d.Baseline), borderColor: '#fd7e14', backgroundColor: '#fd7e14', tension: 0.1, borderWidth: 3, pointRadius: 6, pointHoverRadius: 8 },
                { label: 'Replanting Efforts', data: trendData.map(d => d.Replant), borderColor: '#17a2b8', backgroundColor: '#17a2b8', tension: 0.1, borderWidth: 3, pointRadius: 6, pointHoverRadius: 8 },
                { label: 'Urban Development', data: trendData.map(d => d.Urban), borderColor: '#dc3545', backgroundColor: '#dc3545', tension: 0.1, borderWidth: 3, pointRadius: 6, pointHoverRadius: 8 }
            ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { title: { display: true, text: 'Change from Current (%)' }, ticks: { callback: function(value) { return value + '%'; } }, min: 0, max: 70 } }, plugins: { tooltip: { callbacks: { label: function(context) { return `${context.dataset.label}: ${context.raw.toFixed(1)}%`; }, title: function(context) { return `Return Period: ${context[0].label}`; } } } } }
        });
    }
    
  </script>

  <!-- React Component Definition (using Babel for JSX) -->
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line, AreaChart, Area } = Recharts;

    // --- Helper Functions (copied from modern-water-dashboard.jsx) ---
    const calculateStats = (data) => {
        if (!data || data.length === 0) return { min: 0, max: 0, q1: 0, median: 0, q3: 0, avg: 0 };
        const sorted = [...data].sort((a, b) => a - b);
        const min = sorted[0];
        const max = sorted[sorted.length - 1];
        const q1 = sorted[Math.floor(sorted.length * 0.25)];
        const median = sorted[Math.floor(sorted.length * 0.5)];
        const q3 = sorted[Math.floor(sorted.length * 0.75)];
        const avg = sorted.reduce((a, b) => a + b, 0) / sorted.length;
        return { min, max, q1, median, q3, avg };
    };

    const getDistributionYAxisRange = (yearGroup) => {
        return yearGroup === '2yr' ? [1.0, 2.6] : [7.0, 24.0];
    };

    const generateAreaDistributionData = (yearGroup) => {
        const lowKey = `${yearGroup}-low`;
        const peakKey = `${yearGroup}-peak`;
        
        const lowStats = {
            current: calculateStats(boxPlotData[lowKey]?.current),
            baseline: calculateStats(boxPlotData[lowKey]?.baseline),
            replant: calculateStats(boxPlotData[lowKey]?.replant),
            urban: calculateStats(boxPlotData[lowKey]?.urban)
        };
        
        const peakStats = {
            current: calculateStats(boxPlotData[peakKey]?.current),
            baseline: calculateStats(boxPlotData[peakKey]?.baseline),
            replant: calculateStats(boxPlotData[peakKey]?.replant),
            urban: calculateStats(boxPlotData[peakKey]?.urban)
        };
        
        const mapData = (stats, type) => ([
            { name: 'Current', ...stats.current, type },
            { name: '2050 Baseline', ...stats.baseline, type },
            { name: 'Replant', ...stats.replant, type },
            { name: 'Urban', ...stats.urban, type }
        ]);

        return [
            { group: "Low", data: mapData(lowStats, "Low") },
            { group: "Peak", data: mapData(peakStats, "Peak") }
        ];
    };

    // --- React Component for Distribution Tab ---
    function DistributionAnalysisComponent() {
        const [selectedYearGroup, setSelectedYearGroup] = useState('2yr');
        const [chartHover, setChartHover] = useState(null); // Optional hover state

        // Regenerate data when selectedYearGroup changes
        const areaDistributionData = generateAreaDistributionData(selectedYearGroup);
        const yAxisRange = getDistributionYAxisRange(selectedYearGroup);

        const DistributionTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                const data = payload[0].payload; // Access the data point object
                return (
                    <div className="bg-white p-3 rounded shadow-lg border border-gray-200 text-xs">
                        <div className="font-semibold text-gray-800 mb-1">{data.name} - {data.type}</div>
                        <div className="space-y-1">
                            <div>Min: {data.min?.toFixed(4)} cms</div>
                            <div>Q1: {data.q1?.toFixed(4)} cms</div>
                            <div className="font-medium">Median: {data.median?.toFixed(4)} cms</div>
                            <div>Q3: {data.q3?.toFixed(4)} cms</div>
                            <div>Max: {data.max?.toFixed(4)} cms</div>
                            <div className="font-medium">Average: {data.avg?.toFixed(4)} cms</div>
                        </div>
                    </div>
                );
            }
            return null;
        };

        return (
            <div>
                <h2 className="text-xl font-semibold text-gray-800 mb-1">
                    Distribution Analysis ({selectedYearGroup === '2yr' ? '2-Year' : '200-Year'} Return Period)
                </h2>
                <p className="text-gray-600 mb-4 text-sm italic">Combined low and peak scenario distribution</p>
                
                {/* Period selector */}
                <div className="flex flex-wrap mb-6">
                    <button 
                        onClick={() => setSelectedYearGroup('2yr')} 
                        className={`px-4 py-2 mr-2 mb-2 text-sm rounded-md transition-colors ${
                        selectedYearGroup === '2yr' 
                            ? 'bg-blue-700 text-white' 
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                    >
                        2-Year Return Period
                    </button>
                    <button 
                        onClick={() => setSelectedYearGroup('200yr')} 
                        className={`px-4 py-2 mb-2 text-sm rounded-md transition-colors ${
                        selectedYearGroup === '200yr' 
                            ? 'bg-blue-700 text-white' 
                            : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                        }`}
                    >
                        200-Year Return Period
                    </button>
                </div>
                
                <div 
                    className="bg-blue-50 p-4 rounded-lg mb-6 border-l-4 border-blue-500"
                    onMouseEnter={() => setChartHover('dist')}
                    onMouseLeave={() => setChartHover(null)}
                >
                    <p className={`transition-opacity duration-300 ${chartHover === 'dist' ? 'opacity-100' : 'opacity-70'} text-sm`}>
                        This chart visualizes the statistical distribution of max outflow values for both low and peak events in
                        the {selectedYearGroup === '2yr' ? '2-year' : '200-year'} return period. Each chart shows min/max range, 
                        quartiles (colored areas), median (line), and average values (dots).
                    </p>
                </div>

                {/* Legend - Updated */}
                <div className="flex items-center justify-center mb-6 text-xs text-gray-600 flex-wrap">
                    <div className="flex items-center mr-4 mb-2">
                        <div className="w-4 h-4 bg-blue-100 opacity-50 mr-1"></div>
                        <span>= 25%-75% Quartiles</span>
                    </div>
                    <div className="flex items-center mr-4 mb-2">
                         <div className="w-4 h-px bg-blue-700 mx-1"></div>
                        <span>= Median</span>
                    </div>
                    <div className="flex items-center mr-4 mb-2">
                        <div className="w-2 h-2 rounded-full bg-blue-500 mr-1"></div>
                        <span>= Average</span>
                    </div>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* Low Event Chart - Refactored */}
                    <div>
                        <h3 className="text-lg font-medium text-center mb-2 text-gray-700">Low Events</h3>
                        <div className="h-80">
                            <ResponsiveContainer width="100%" height="100%">
                                <AreaChart
                                    data={areaDistributionData[0].data}
                                    margin={{ top: 5, right: 20, left: 10, bottom: 5 }}
                                >
                                    <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                                    <XAxis dataKey="name" tick={{ fontSize: 10 }} />
                                    <YAxis 
                                        domain={yAxisRange}
                                        label={{ value: `Max Outflow (cms)`, angle: -90, position: 'insideLeft', style: { textAnchor: 'middle', fontSize: 11 }, dx:-10 }}
                                        tick={{ fontSize: 10 }}
                                        tickFormatter={(val) => val.toFixed(1)}
                                        allowDataOverflow={true} // Prevent clipping of area/line near boundaries
                                    />
                                    <Tooltip content={<DistributionTooltip />} />
                                    
                                    {/* Area for Q1-Q3 Range */}
                                    <Area 
                                        type="monotone" 
                                        dataKey={['q1', 'q3']} // Define range using q1 and q3
                                        stroke="none" 
                                        fill="rgba(0,86,179,0.2)" // Blue fill for low events
                                        fillOpacity={0.6}
                                        name="Quartile Range (Q1-Q3)"
                                    />

                                    {/* Median Line */}
                                    <Line 
                                        type="monotone" 
                                        dataKey="median" 
                                        stroke="#0056b3" // Darker blue for median
                                        strokeWidth={2} 
                                        dot={false} 
                                        activeDot={false} 
                                        name="Median"
                                    />
                                    
                                    {/* Average Dot (using Line with only dots) */}
                                    <Line 
                                        type="monotone" 
                                        dataKey="avg" 
                                        stroke="transparent" // Hide the line itself
                                        dot={{ r: 4, fill: '#2196F3', strokeWidth: 1, stroke: '#0056b3' }}
                                        activeDot={{ r: 6 }}
                                        name="Average"
                                    />
                                </AreaChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                    
                    {/* Peak Event Chart - Refactored */}
                    <div>
                        <h3 className="text-lg font-medium text-center mb-2 text-gray-700">Peak Events</h3>
                        <div className="h-80">
                            <ResponsiveContainer width="100%" height="100%">
                                <AreaChart
                                    data={areaDistributionData[1].data}
                                    margin={{ top: 5, right: 20, left: 10, bottom: 5 }}
                                >
                                    <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                                    <XAxis dataKey="name" tick={{ fontSize: 10 }} />
                                    <YAxis 
                                        domain={yAxisRange}
                                        label={{ value: `Max Outflow (cms)`, angle: -90, position: 'insideLeft', style: { textAnchor: 'middle', fontSize: 11 }, dx:-10 }}
                                        tick={{ fontSize: 10 }}
                                        tickFormatter={(val) => val.toFixed(1)}
                                        allowDataOverflow={true} // Prevent clipping
                                    />
                                    <Tooltip content={<DistributionTooltip />} />
                                    
                                    {/* Area for Q1-Q3 Range */}
                                    <Area 
                                        type="monotone" 
                                        dataKey={['q1', 'q3']} // Define range using q1 and q3
                                        stroke="none" 
                                        fill="rgba(220,53,69,0.2)" // Red fill for peak events
                                        fillOpacity={0.6}
                                        name="Quartile Range (Q1-Q3)"
                                    />

                                    {/* Median Line */}
                                    <Line 
                                        type="monotone" 
                                        dataKey="median" 
                                        stroke="#dc3545" // Darker red for median
                                        strokeWidth={2} 
                                        dot={false} 
                                        activeDot={false} 
                                        name="Median"
                                    />
                                    
                                    {/* Average Dot */}
                                    <Line 
                                        type="monotone" 
                                        dataKey="avg" 
                                        stroke="transparent" 
                                        dot={{ r: 4, fill: '#dc3545', strokeWidth: 1, stroke: '#b02a37' }}
                                        activeDot={{ r: 6 }}
                                        name="Average"
                                    />
                                </AreaChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                </div>
                
                {/* Statistics and Insights */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                    <div className="bg-gray-100 p-4 rounded-lg">
                        <h3 className="font-semibold text-lg mb-2 text-gray-800">Key Statistics</h3>
                        <div className="overflow-x-auto">
                            <table className="min-w-full bg-white rounded-lg overflow-hidden text-xs">
                                <thead className="bg-gray-200">
                                <tr>
                                    <th className="px-3 py-2 text-left font-semibold text-gray-700">Scenario</th>
                                    <th className="px-3 py-2 text-left font-semibold text-gray-700">Type</th>
                                    <th className="px-3 py-2 text-left font-semibold text-gray-700">Min</th>
                                    <th className="px-3 py-2 text-left font-semibold text-gray-700">Max</th>
                                    <th className="px-3 py-2 text-left font-semibold text-gray-700">Average</th>
                                </tr>
                                </thead>
                                <tbody>
                                {areaDistributionData[0].data.map((item, index) => (
                                    <tr key={`low-${index}`} className={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                                    <td className="px-3 py-2 text-gray-800 font-medium">{item.name}</td>
                                    <td className="px-3 py-2 text-gray-800">Low</td>
                                    <td className="px-3 py-2 text-gray-800">{item.min?.toFixed(3)}</td>
                                    <td className="px-3 py-2 text-gray-800">{item.max?.toFixed(3)}</td>
                                    <td className="px-3 py-2 text-gray-800">{item.avg?.toFixed(3)}</td>
                                    </tr>
                                ))}
                                {areaDistributionData[1].data.map((item, index) => (
                                    <tr key={`peak-${index}`} className={index % 2 === 1 ? 'bg-gray-50' : 'bg-white'}>
                                    <td className="px-3 py-2 text-gray-800 font-medium">{item.name}</td>
                                    <td className="px-3 py-2 text-gray-800">Peak</td>
                                    <td className="px-3 py-2 text-gray-800">{item.min?.toFixed(3)}</td>
                                    <td className="px-3 py-2 text-gray-800">{item.max?.toFixed(3)}</td>
                                    <td className="px-3 py-2 text-gray-800">{item.avg?.toFixed(3)}</td>
                                    </tr>
                                ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div className="bg-gray-100 p-4 rounded-lg">
                        <h3 className="font-semibold text-lg mb-2 text-gray-800">Key Insights</h3>
                        {selectedYearGroup === '2yr' ? (
                        <ul className="list-disc pl-5 space-y-2 text-sm text-gray-800">
                            <li>The <span className="font-medium">Urban</span> scenario shows the highest peak flow values (~2.44 cms avg).</li>
                            <li>The <span className="font-medium">Current</span> conditions have the lowest outflow values across both low and peak events.</li>
                            <li>The <span className="font-medium">Replant</span> strategy shows noticeable reduction compared to Baseline, especially for peak events.</li>
                            <li>The relative difference between low and peak events stays consistent across all scenarios.</li>
                        </ul>
                        ) : (
                        <ul className="list-disc pl-5 space-y-2 text-sm text-gray-800">
                            <li>All future scenarios show dramatically higher values (~60%+) compared to current conditions.</li>
                            <li>The <span className="font-medium">Replant</span> scenario offers minimal reduction for extreme 200-year events compared to Baseline.</li>
                            <li>The <span className="font-medium">Urban</span> development impact becomes less significant relative to Baseline at 200-year peak events.</li>
                            <li>The gap between low and peak values is much wider than in 2-year return periods.</li>
                        </ul>
                        )}
                    </div>
                </div>
            </div>
        );
    }
    
    // Make the component globally available for the main script
    window.DistributionAnalysisComponent = DistributionAnalysisComponent;

  </script>
</body>
</html>